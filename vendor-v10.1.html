<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>牙材券消費登錄</title>
  <style>
    body {
      font-family: 'Inter','Noto Sans TC',sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 500px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background: #4caf50;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #43a047;
    }
    #vendorDisplay {
      margin-bottom: 10px;
      font-weight: bold;
      color: #2e7d32;
      text-align: center;
    }
    #message {
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>牙材券消費登錄</h2>

    <!-- 顯示目前的廠商（網址有帶 vendor 參數時才會出現） -->
    <div id="vendorDisplay"></div>

    <form id="voucherForm">
      <label for="doctor">醫師姓名：</label>
      <input type="text" id="doctor" name="doctor" required>

      <label for="voucher">牙材卷號：</label>
      <input type="text" id="voucher" name="voucher" required>

      <label for="amount">使用金額：</label>
      <input type="number" id="amount" name="amount" required>

      <label for="phone">手機：</label>
      <input type="text" id="phone" name="phone" required>

      <label for="vendor">廠商：</label>
      <select id="vendor" name="vendor" required>
        <option value="">請選擇廠商</option>
        <option value="A公司">A公司</option>
        <option value="B公司">B公司</option>
        <option value="C公司">C公司</option>
      </select>

      <label for="note">備註：</label>
      <input type="text" id="note" name="note">

      <label for="datetime">日期時間：</label>
      <input type="datetime-local" id="datetime" name="datetime" required>

      <button type="submit">送出</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwv0d4S-MFwN-qM9dPYIltM4zxFgjljpZnP9-AnqFbcNZi2xYjWm9MFL4rREEwTHI6N/exec';

    // ===== vendor 處理邏輯 =====
    const urlParams = new URLSearchParams(window.location.search);
    const vendorParam = urlParams.get('vendor');
    const vendorSelect = document.getElementById('vendor');
    const vendorDisplay = document.getElementById('vendorDisplay');

    if (vendorParam) {
      let found = false;
      for (let option of vendorSelect.options) {
        if (option.value === vendorParam) {
          option.selected = true;
          found = true;
          break;
        }
      }
      if (found) {
        vendorDisplay.textContent = `目前廠商：${vendorParam}`;
      } else {
        vendorDisplay.textContent = `網址帶的廠商「${vendorParam}」不在選單中`;
      }
    } else {
      vendorSelect.value = "";
      vendorDisplay.textContent = "";
    }

    // ===== 表單送出處理 =====
    document.getElementById('voucherForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 'Content-Type': 'text/plain' }
        });
        const result = await response.json();
        if (result.success) {
          document.getElementById('message').textContent =
            `✅ 已成功在「${data.vendor}」消費 ${data.amount} 元`;
          document.getElementById('message').style.color = "green";
          this.reset();
          vendorSelect.value = vendorParam || "";
        } else {
          document.getElementById('message').textContent = "❌ " + result.message;
          document.getElementById('message').style.color = "red";
        }
      } catch (error) {
        document.getElementById('message').textContent = "⚠️ 發生錯誤，請稍後再試";
        document.getElementById('message').style.color = "red";
      }
    });
  </script>
</body>
</html>
